{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/leads.css' %}">
<link rel="stylesheet" href="{% static 'css/tables.css' %}">
<link rel="stylesheet" href="{% static 'css/forms.css' %}">
<style>
/* Стили для таблицы лидов */
#leads-table th:nth-child(1),
#leads-table td:nth-child(1) {
  width: 40px;
  min-width: 40px;
  max-width: 80px;
}

/* Действия */
#leads-table th:nth-child(2),
#leads-table td:nth-child(2) {
  width: 80px;
  min-width: 80px;
  max-width: 100px;
  text-align: center;
}

/* Статус */
#leads-table th:nth-child(3),
#leads-table td:nth-child(3) {
  width: 120px;
  min-width: 100px;
  max-width: 140px;
}

/* Источник */
#leads-table th:nth-child(4),
#leads-table td:nth-child(4) {
  width: 120px;
  min-width: 100px;
  max-width: 140px;
}

/* Дата добавления */
#leads-table th:nth-child(5),
#leads-table td:nth-child(5) {
  width: 100px;
  min-width: 90px;
  max-width: 120px;
}

/* Телефон */
#leads-table th:nth-child(6),
#leads-table td:nth-child(6) {
  width: 120px;
  min-width: 100px;
  max-width: 140px;
}

/* Имя родителя */
#leads-table th:nth-child(7),
#leads-table td:nth-child(7) {
  width: 150px;
  min-width: 120px;
  max-width: 180px;
}

/* Интерес */
#leads-table th:nth-child(8),
#leads-table td:nth-child(8) {
  width: 100px;
  min-width: 80px;
  max-width: 120px;
}

/* Комментарий */
#leads-table th:nth-child(9),
#leads-table td:nth-child(9) {
  width: 200px;
  min-width: 150px;
  max-width: 250px;
}

/* Перезвонить */
#leads-table th:nth-child(10),
#leads-table td:nth-child(10) {
  width: 120px;
  min-width: 100px;
  max-width: 140px;
}

.callback-warning {
  background-color: #fff3cd !important;
  color: #856404 !important;
}

.callback-danger {
  background-color: #f8d7da !important;
  color: #721c24 !important;
}

/* Стили для фильтров как в schedule_detail */
.filter-section {
  margin-top: 20px;
  margin-bottom: 20px;
  padding: 15px;
  background-color: #f8f9fa;
  border-radius: 8px;
  border: 1px solid #e9ecef;
}

.filter-row {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  align-items: flex-end;
}

.filter-group {
  flex: 1;
  min-width: 180px;
}

.filter-group label {
  display: block;
  margin-bottom: 5px;
  font-weight: 500;
  color: #495057;
}

@media (max-width: 768px) {
  .filter-group {
    min-width: 100%;
  }
  
  .filter-row {
    gap: 15px;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
  <a href="{% url 'dashboard' %}" class="btn btn-secondary mb-3">
    &larr; Назад на главную
  </a>

  <div class="card shadow-sm">
    <div class="card-header bg-primary text-white">
      <div class="d-flex justify-content-between align-items-center">
        <h3 class="mb-0">Лиды</h3>
        <div>
          <button type="button" class="btn btn-light" id="add-lead-btn">
            <i class="bi bi-plus-lg"></i> Добавить лид
          </button>
        </div>
      </div>
    </div>

    <div class="card-body">
      <!-- Фильтры в стиле schedule_detail -->
      <div class="filter-section">
        <div class="filter-row">
          <div class="filter-group">
            <label>Статус</label>
            <select id="status-filter" class="form-select">
              <option value="">Все статусы</option>
              {% for status in status_choices %}
              <option value="{{ status.0 }}">{{ status.1 }}</option>
              {% endfor %}
            </select>
          </div>
          
          <div class="filter-group">
            <label>Источник</label>
            <select id="source-filter" class="form-select">
              <option value="">Все источники</option>
              {% for source in source_choices %}
              <option value="{{ source.0 }}">{{ source.1 }}</option>
              {% endfor %}
            </select>
          </div>
          
          <div class="filter-group">
            <label>Сортировка</label>
            <select id="sort-filter" class="form-select">
              <option value="">Сортировать по...</option>
              <option value="date-desc">Дате (новые сначала)</option>
              <option value="date-asc">Дате (старые сначала)</option>
              <option value="name-asc">Имени (А-Я)</option>
              <option value="name-desc">Имени (Я-А)</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label>&nbsp;</label>
            <button id="reset-filters" class="btn btn-secondary w-100">
              <i class="bi bi-arrow-clockwise"></i> Сбросить
            </button>
          </div>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-striped table-hover" id="leads-table">
          <thead>
            <tr>
              <th>№</th>
              <th><i class="bi bi-gear-fill text-secondary fs-5"></i></th>
              <th>Статус</th>
              <th>Источник</th>
              <th>Дата добавления</th>
              <th>Телефон</th>
              <th>Имя родителя</th>
              <th>Интерес</th>
              <th>Комментарий</th>
              <th>Перезвонить</th>
            </tr>
          </thead>
          <tbody>
            {% for lead in leads %}
            <tr id="lead-{{ lead.id }}" 
                data-status="{{ lead.status }}" 
                data-source="{{ lead.source }}"
                data-date="{{ lead.added_date|date:'Y-m-d' }}"
                data-name="{{ lead.parent_name }}"
                {% if lead.callback_date %}
                  {% if lead.is_callback_overdue %}class="callback-danger"
                  {% elif lead.is_callback_today %}class="callback-warning"{% endif %}
                {% endif %}>
              <td>{{ forloop.counter }}</td>
              <td>
                <button class="btn p-0 border-0 bg-transparent icon-btn edit-lead-btn"
                        data-lead-id="{{ lead.id }}">
                  <i class="bi bi-pencil text-primary"></i>
                </button>
                <button class="btn p-0 border-0 bg-transparent icon-btn delete-lead-btn"
                        data-lead-id="{{ lead.id }}">
                  <i class="bi bi-trash text-danger"></i>
                </button>
              </td>
              <td>
                <span class="lead-status-{{ lead.status }}">
                  {{ lead.get_status_display }}
                </span>
              </td>
              <td>{{ lead.get_source_display }}</td>
              <td>{{ lead.added_date|date:"d.m.Y" }}</td>
              <td>{{ lead.phone }}</td>
              <td>{{ lead.parent_name }}</td>
              <td>{{ lead.interest }}</td>
              <td>{{ lead.comment }}</td>
              <td>
                {% if lead.callback_date %}
                  {{ lead.callback_date|date:"d.m.Y H:i" }}
                  {% if lead.is_callback_overdue %}
                    <i class="bi bi-exclamation-triangle-fill text-danger"></i>
                  {% elif lead.is_callback_today %}
                    <i class="bi bi-bell-fill text-warning"></i>
                  {% endif %}
                {% else %}
                  —
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Модальное окно для работы с лидами -->
<div class="modal fade" id="leadModal" tabindex="-1" aria-labelledby="leadModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content" id="lead-modal-content">
      <!-- Сюда будет загружаться форма -->
    </div>
  </div>
</div>

<!-- Модальное окно для создания лида -->
<div class="modal fade" id="createLeadModal" tabindex="-1" aria-labelledby="createLeadModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="createLeadModalLabel">Создать новый лид</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="create-lead-form">
          {% csrf_token %}
          <div class="mb-3">
            <label for="status" class="form-label">Статус *</label>
            <select class="form-select" id="status" name="status" required>
              {% for status in status_choices %}
              <option value="{{ status.0 }}">{{ status.1 }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label for="source" class="form-label">Источник *</label>
            <select class="form-select" id="source" name="source" required>
              {% for source in source_choices %}
              <option value="{{ source.0 }}">{{ source.1 }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label for="phone" class="form-label">Телефон *</label>
            <input type="tel" class="form-control" id="phone" name="phone" required>
          </div>
          <div class="mb-3">
            <label for="parent_name" class="form-label">Имя родителя</label>
            <input type="text" class="form-control" id="parent_name" name="parent_name">
          </div>
          <div class="mb-3">
            <label for="interest" class="form-label">Интерес</label>
            <input type="text" class="form-control" id="interest" name="interest">
          </div>
          <div class="mb-3">
            <label for="comment" class="form-label">Комментарий</label>
            <textarea class="form-control" id="comment" name="comment" rows="3"></textarea>
          </div>
          <div class="mb-3">
            <label for="callback_date" class="form-label">Дата перезвона</label>
            <input type="date" class="form-control" id="callback_date" name="callback_date">
          </div>
          <div class="mb-3">
            <label for="callback_time" class="form-label">Время перезвона</label>
            <input type="time" class="form-control" id="callback_time" name="callback_time">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
        <button type="button" class="btn btn-primary" id="save-lead-btn">Сохранить</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
  // Глобальные переменные
  const CSRF_TOKEN = "{{ csrf_token }}";
</script>
<script src="{% static 'js/utils.js' %}"></script>
<script src="{% static 'js/lead_list.js' %}"></script>
{% endblock %}