<div class="modal-header">
  <h5 class="modal-title">Редактирование сотрудника</h5>
  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<div class="modal-body">
  <form id="employee-quick-edit-form" method="post" action="{% url 'employee_quick_edit' employee.id %}">
    {% csrf_token %}
    
    <!-- Скрытое поле для передачи schedule_id -->
    {% if request.GET.schedule_id %}
    <input type="hidden" name="schedule_id" value="{{ request.GET.schedule_id }}">
    <input type="hidden" name="schedule" value="{{ request.GET.schedule_id }}">
    {% endif %}
    
    <!-- Информация о текущей смене (только для чтения) -->
    {% if request.GET.schedule_id %}
    <div class="mb-3">
      <label class="form-label">Смена</label>
      <div class="form-control form-control-plaintext">
        {{ employee.schedule.name|default:"Текущая смена" }}
      </div>
      <input type="hidden" name="schedule" value="{{ request.GET.schedule_id }}">
    </div>
    {% endif %}
    
    <!-- Остальные поля формы, кроме schedule и squad -->
    {% for field in form %}
      {% if field.name != 'schedule' and field.name != 'squad' %}
      <div class="mb-3">
        <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
        {{ field }}
        {% if field.errors %}
          <div class="invalid-feedback d-block">
            {% for error in field.errors %}
              {{ error }}
            {% endfor %}
          </div>
        {% endif %}
      </div>
      {% endif %}
    {% endfor %}
    
    <!-- Поле выбора отряда (только для текущей смены) -->
    {% if request.GET.schedule_id and not form.squad.is_hidden %}
    <div class="mb-3" id="squad-field-container">
      <label for="{{ form.squad.id_for_label }}" class="form-label">Отряд (вожатый)</label>
      <div class="alert alert-info p-2 mb-2">
        <small>
          <i class="bi bi-info-circle"></i> 
          Отображаются только отряды текущей смены.<br>
          Если выбрать отряд, сотрудник станет вожатым этого отряда.
        </small>
      </div>
      {{ form.squad }}
      {% if form.squad.errors %}
        <div class="invalid-feedback d-block">
          {% for error in form.squad.errors %}
            {{ error }}
          {% endfor %}
        </div>
      {% endif %}
    </div>
    {% endif %}
    
    <div class="d-flex justify-content-between">
      <button type="submit" class="btn btn-primary">Сохранить</button>
      {% if request.resolver_match.url_name == 'employees_list' %}
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Отменить
        </button>
      {% else %}
        <button type="button" class="btn btn-danger" 
                id="delete-employee-btn" 
                data-employee-id="{{ employee.id }}">
          Удалить
        </button>
      {% endif %}
    </div>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Функция для загрузки отрядов по выбранной смене
    function loadSquads(scheduleId) {
        const squadField = document.getElementById('{{ form.squad.id_for_label }}');
        const squadFieldContainer = document.getElementById('squad-field-container');
        
        if (!scheduleId || !squadField) {
            if (squadFieldContainer) {
                squadFieldContainer.style.display = 'none';
            }
            return;
        }
        
        // Показываем поле отряда
        if (squadFieldContainer) {
            squadFieldContainer.style.display = 'block';
        }
        
        // Загружаем отряды для выбранной смены
        fetch(`/api/students/squads/?schedule_id=${scheduleId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Сохраняем текущее значение
                const currentValue = squadField.value;
                
                // Очищаем и заполняем опции
                squadField.innerHTML = '<option value="">Не выбран</option>';
                data.forEach(squad => {
                    const option = document.createElement('option');
                    option.value = squad.id;
                    option.textContent = squad.name;
                    if (squad.id == currentValue) {
                        option.selected = true;
                    }
                    squadField.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Ошибка при загрузке отрядов:', error);
            });
    }
    
    // Находим поле выбора смены
    const scheduleField = document.getElementById('{{ form.schedule.id_for_label }}');
    const squadField = document.getElementById('{{ form.squad.id_for_label }}');
    
    // Если поле смены существует, добавляем обработчик
    if (scheduleField) {
        // Загружаем отряды при изменении смены
        scheduleField.addEventListener('change', function() {
            loadSquads(this.value);
        });
        
        // Инициализируем загрузку отрядов при открытии формы, если смена уже выбрана
        if (scheduleField.value) {
            loadSquads(scheduleField.value);
        } else if (squadField && squadField.value) {
            // Если нет смены, но есть отряд - скрываем поле
            const squadFieldContainer = document.getElementById('squad-field-container');
            if (squadFieldContainer) {
                squadFieldContainer.style.display = 'none';
            }
        }
    }
    
    // Если schedule_id передан в GET-параметре, сразу загружаем отряды
    {% if request.GET.schedule_id %}
    loadSquads('{{ request.GET.schedule_id }}');
    {% endif %}
});
</script>