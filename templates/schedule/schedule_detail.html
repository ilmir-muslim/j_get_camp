{% extends 'base.html' %}
{% load custom_tags %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/schedule_detail.css' %}">
<link rel="stylesheet" href="{% static 'css/attendance_table.css' %}">
{% endblock %}

{% block content %}
<div class="container page-container">
    <!-- Кнопка Назад -->
    {% if from_schedule_list %}
        <a href="{% url 'schedule_list' %}" class="btn btn-secondary mb-3">
            &larr; Назад к списку смен
        </a>
    {% else %}
        <a href="{% url 'schedule_calendar' %}" class="btn btn-secondary mb-3">
            &larr; Назад к календарю
        </a>
    {% endif %}
    
    <h1>{{ schedule.name }}</h1>
    <p class="lead">{{ schedule.start_date }} - {{ schedule.end_date }} | {{ schedule.branch.name }}</p>
    <p><strong>Тематика:</strong> {{ schedule.theme }}</p>
    
    <!-- Универсальное модальное окно для форм -->
    <div class="modal fade" id="universalFormModal" tabindex="-1" aria-labelledby="universalFormModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content" id="universalFormModalContent">
                <!-- Сюда будет загружаться контент -->
            </div>
        </div>
    </div>
    
    <!-- Сотрудники группы - на всю ширину -->
    <div class="card mb-5">
        <div class="card-header bg-primary text-white">
            <h3>Сотрудники группы</h3>
        </div>
        <div class="card-body">
            <!-- Форма сотрудника -->
            <div class="form-container">
                <form method="post" id="employee-form" action="{% url 'schedule_detail' pk=schedule.pk %}">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="add_employee">
                    <div class="form-grid">
                        <div class="select-wrapper">
                            <label class="form-label">Добавить сотрудника</label>
                            <select name="employee" class="form-select" required>
                                <option value="">Выберите сотрудника</option>
                                {% for emp in available_employees %}
                                    <option value="{{ emp.id }}">{{ emp.full_name }} ({{ emp.get_position_display }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <button type="submit" class="btn btn-success">Добавить</button>
                        <button type="button" class="btn btn-primary" id="create-employee-btn">Создать</button>
                    </div>
                </form>
            </div>
            
                <div class="table-responsive" id="employees-table-container">
                <table class="attendance-table attendance-table-employees">       
                    <thead>
                        <tr>
                            <th>№</th>
                            <th><i class="bi bi-gear-fill text-secondary fs-5"></i></th>
                            <th>ФИО</th>
                            <th>Должность</th>
                            <th>Ставка, руб/день</th>
                            <th>Явка</th>
                            {% for date in dates %}
                                <th class="text-center date-cell" data-date="{{ date|date:'Y-m-d' }}">
                                    {{ date|date:"d.m" }}<br>
                                    <small>{{ date|date:"D" }}</small>
                                </th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody id="employees-table">
                        {% for employee in employees %}
                            <tr id="employee-{{ employee.id }}">
                                <td>{{ forloop.counter }}</td>
                                <td>
                                    <button class="btn p-0 border-0 bg-transparent icon-btn remove-employee"
                                            data-employee-id="{{ employee.id }}"
                                            data-employee-display="{{ employee.full_name }} ({{ employee.get_position_display }})"
                                            data-schedule-id="{{ schedule.id }}"
                                            data-bs-toggle="tooltip" title="Удалить">
                                    <i class="bi bi-trash text-danger fs-5"></i>
                                    </button>
                                </td>
                                <td class="student-column">{{ employee.full_name }}</td>
                                <td>{{ employee.get_position_display }}</td>
                                <td>{{ employee.rate_per_day }}</td>
                                <td class="text-center">{{ employee_attendance_counts|get_item:employee.id }}</td>
                                {% for date in dates %}
                                    {% with key=employee.id|stringformat:"s"|add:"_"|add:date.isoformat %}
                                        <td class="date-cell" data-date="{{ date|date:'Y-m-d' }}">
                                            <div class="attendance-cell-wrapper"> 
                                            <div class="attendance-cell text-center 
                                                {% if employee_attendance|get_item:key == 'present' %}bg-success
                                                {% elif employee_attendance|get_item:key == 'excused' %}bg-warning
                                                {% else %}bg-danger
                                                {% endif %}" 
                                                data-employee-id="{{ employee.id }}"
                                                data-date="{{ date|date:'Y-m-d' }}"
                                                data-attendance-type="{% if employee_attendance|get_item:key == 'present' %}present{% elif employee_attendance|get_item:key == 'excused' %}excused{% else %}absent{% endif %}">
                                                {% if employee_attendance|get_item:key == 'present' %}
                                                    <i class="bi bi-check-lg text-white"></i>
                                                {% elif employee_attendance|get_item:key == 'excused' %}
                                                    <i class="bi bi-exclamation-lg text-white"></i>
                                                {% else %}
                                                    <i class="bi bi-x-lg text-white"></i>
                                                {% endif %}
                                            </div>
                                            </div>
                                        </td>
                                    {% endwith %}
                                {% endfor %}
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="{{ 5|add:dates|length|add:1 }}" class="text-center">
                                    Нет сотрудников
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr id="employee-total-row">
                            <td colspan="6" class="text-end"><strong>Итого</strong></td>
                            {% for date in dates %}
                                <td class="date-cell text-center bg-light" data-date="{{ date|date:'Y-m-d' }}">
                                    <div class="attendance-cell-wrapper">
                                    <span class="present-count">0</span>
                                    </div>
                                </td>
                            {% endfor %}
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>  
    
    <!-- Таблица посещаемости -->
    <div class="card mb-5">
        <div class="card-header bg-primary text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h3>Посещаемость</h3>
                <div>
                     <a href="{% url 'export_schedule_attendance_excel' pk=schedule.pk %}" class="btn btn-light me-2">
                        <i class="bi bi-file-earmark-excel"></i> Excel
                    </a>
                    <a href="{% url 'export_schedule_attendance_pdf' pk=schedule.pk %}" class="btn btn-light me-2">
                        <i class="bi bi-file-earmark-pdf"></i> PDF
                    </a>
                    <button id="reset-attendance-filters" class="btn btn-light btn-action">
                        <i class="bi bi-arrow-clockwise"></i> Сбросить фильтры
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body">
            <!-- Форма ученика -->
        <div class="form-container">
            <form method="post" id="student-form-attendance" action="{% url 'schedule_detail' pk=schedule.pk %}">
                {% csrf_token %}
                <input type="hidden" name="action" value="add_student">
                <div class="form-grid">
                    <div class="select-wrapper">
                        <label class="form-label">Добавить ученика</label>
                        <!-- Заменяем select на input с datalist -->
                        <input list="students-datalist" id="student-search-input" name="student" 
                            class="form-control" placeholder="Начните вводить ФИО ученика" autocomplete="off">
                        <datalist id="students-datalist">
                            {% for student in available_students %}
                                <option value="{{ student.full_name }}" data-id="{{ student.id }}">
                            {% endfor %}
                        </datalist>
                        <!-- Скрытое поле для хранения ID выбранного студента -->
                        <input type="hidden" id="student-id-input" name="student_id">
                    </div>
                    <button type="submit" class="btn btn-success">Добавить</button>
                    <button type="button" class="btn btn-primary" id="create-student-btn">Создать</button>
                </div>
            </form>
        </div>
            <!-- Фильтры -->
            <div class="filter-section">
                <div class="filter-row">
                    <div class="filter-group">
                        <label>Фильтр по ученику</label>
                        <input type="text" id="attendance-student-filter" class="form-control" placeholder="ФИО ученика">
                    </div>
                                    
                    <div class="filter-group">
                        <label>Тип</label>
                        <select id="attendance-type-filter" class="form-select">
                            <option value="">Все типы</option>
                            <option value="camp">Лагерь</option>
                            <option value="lab">Лаборатория</option>
                            <option value="full_day">Полный день</option>
                        </select>
                    </div>          

                    <div class="filter-group">
                        <label>Сортировка</label>
                        <select id="attendance-sort" class="form-select">
                            <option value="">Сортировать по...</option>
                            <option value="name-asc">Имя (А-Я)</option>
                            <option value="name-desc">Имя (Я-А)</option>
                            <option value="visits-asc">Посещения (↑)</option>
                            <option value="visits-desc">Посещения (↓)</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="table table-bordered attendance-table">
                    <thead>
                        <tr>
                            <th>№</th>
                            <th><i class="bi bi-gear-fill text-secondary fs-5"></i></th>
                            <th>Стоимость</th>
                            <th>Платежи</th>
                            <th>Тип</th>
                            <th>ФИО</th>
                            <th>Явка</th>
                            {% for date in dates %}
                                <th class="text-center date-cell" data-date="{{ date|date:'Y-m-d' }}">
                                    {{ date|date:"d.m" }}<br>
                                    <small>{{ date|date:"D" }}</small>
                                </th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody id="attendance-body">
                        {% for student in students %}
                            <tr data-student-id="{{ student.id }}" data-visits="{{ student_attendance_counts|get_item:student.id }}"
                            data-attendance-type="{{ student.attendance_type }}">
                                <td>{{ forloop.counter }}</td>
                                <td>
                                    <!-- Кнопка платежа -->
                                    <button class="btn p-0 border-0 bg-transparent icon-btn student-payment-btn"
                                            data-student-id="{{ student.id }}"
                                            data-student-name="{{ student.full_name }}"
                                            data-schedule-id="{{ schedule.id }}"
                                            data-bs-toggle="tooltip" title="Добавить платеж">
                                        <i class="bi bi-cash text-success fs-5"></i>
                                    </button>
                                    <!-- Кнопка пополнения баланса -->
                                    <button class="btn p-0 border-0 bg-transparent icon-btn add-balance-btn"
                                            data-student-id="{{ student.id }}"
                                            data-bs-toggle="tooltip" title="Пополнить баланс">
                                    <i class="bi bi-wallet2 text-success"></i>
                                    </button>
                                    
                                    <!-- Кнопка удаления -->
                                    <button class="btn p-0 border-0 bg-transparent icon-btn remove-student-attendance"
                                            data-student-id="{{ student.id }}"
                                            data-student-name="{{ student.full_name }}"
                                            data-schedule-id="{{ schedule.id }}"
                                            data-bs-toggle="tooltip" title="Удалить">
                                        <i class="bi bi-trash text-danger fs-5"></i>
                                    </button>
                                </td>
                                <td>{{ student.individual_price|default:student.default_price }}</td>
                                <td>
                                    {% with total_paid=student_total_payments|get_item:student.id %}
                                        {% if total_paid %}
                                            {{ total_paid|floatformat:2 }}
                                        {% else %}
                                            —
                                        {% endif %}
                                    {% endwith %}
                                </td>
                                <td>{{ student.get_attendance_type_display }}</td>
                                <td class="student-column">{{ student.full_name }}</td>
                                <td>{{ student_attendance_counts|get_item:student.id }}</td>
                                {% for date in dates %}
                                    {% with key=student.id|stringformat:"s"|add:"_"|add:date.isoformat %}
                                        <td class="date-cell" data-date="{{ date|date:'Y-m-d' }}">
                                            <div class="attendance-cell text-center 
                                                {% if attendance|get_item:key == 'present' %}bg-success
                                                {% elif attendance|get_item:key == 'excused' %}bg-warning
                                                {% else %}bg-danger
                                                {% endif %}" 
                                                data-student-id="{{ student.id }}"
                                                data-date="{{ date|date:'Y-m-d' }}"
                                                data-attendance-type="{% if attendance|get_item:key == 'present' %}present{% elif attendance|get_item:key == 'excused' %}excused{% else %}absent{% endif %}">
                                                {% if attendance|get_item:key == 'present' %}
                                                    <i class="bi bi-check-lg text-white"></i>
                                                {% elif attendance|get_item:key == 'excused' %}
                                                    <i class="bi bi-exclamation-lg text-white"></i>
                                                {% else %}
                                                    <i class="bi bi-x-lg text-white"></i>
                                                {% endif %}
                                            </div>
                                        </td>
                                    {% endwith %}
                                {% endfor %}
                            </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr id="student-total-row">
                            <td colspan="3" class="text-end"><strong>Итого:</strong></td>
                            <td class="text-center" id="total-payments-cell"><strong>{{ total_payments|default:0|floatformat:2 }}</strong></td>
                            <td colspan="3"></td> 
                            {% for date in dates %}
                                <td class="date-cell text-center bg-light" data-date="{{ date|date:'Y-m-d' }}">
                                    <div class="attendance-cell-wrapper">
                                    <span class="present-count"></span>
                                    </div>
                                </td>
                            {% endfor %}
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
    

<!-- Расходы и финансовая сводка -->
<div class="row">
    <div class="col-md-8">
        <div class="card mb-5">
            <div class="card-header bg-primary text-white">
                <h3>Расходы</h3>
            </div>
            <div class="card-body">
                <!-- Форма расходов -->
                <div class="form-container">
                    <div class="form-grid">
                        <div></div>
                        <button type="button" class="btn btn-success" id="add-expense-btn">Добавить расход</button>
                        <div></div>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-bordered attendance-table expenses-table">
                        <thead>
                            <tr>
                                <th>№</th>
                                <th><i class="bi bi-gear-fill text-secondary fs-5"></i></th>
                                <th>Категория</th>
                                <th>Комментарий</th>
                                <th>Сумма, руб</th>
                            </tr>
                        </thead>
                        <tbody id="expenses-table-body">
                            {% for expense in expenses %}
                            <tr data-expense-id="{{ expense.id }}" class="clickable-expense-row">
                                <td>{{ forloop.counter }}</td>
                                <td>
                                    <button class="btn p-0 border-0 bg-transparent icon-btn delete-expense-btn"
                                            data-expense-id="{{ expense.id }}"
                                            data-bs-toggle="tooltip" title="Удалить">
                                        <i class="bi bi-trash text-danger fs-5"></i>
                                    </button>
                                </td>
                                <td>{{ expense.get_category_display }}</td>
                                <td>{{ expense.comment }}</td>
                                <td>{{ expense.amount }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center">Нет расходов</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr class="total-summary-row">
                                <td colspan="4" class="text-end"><strong>Итого:</strong></td>
                                <td class="text-center"><strong>{{ total_expenses_sum }}</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card mb-5">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Финансовая сводка</h5>
            </div>
            <div class="card-body">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Расход</th>
                            <th>Доход</th>
                            <th>Сальдо</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td id="finance-expense">{{ total_expenses_sum|default:0|floatformat:"0" }} руб.</td>
                            <td id="finance-income">{{ total_payments|default:0|floatformat:"0" }} руб.</td>
                            <td id="finance-balance">0 руб.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
    
    <!-- Модальное окно для создания ученика -->
    <div class="modal fade" id="createStudentModal" tabindex="-1" aria-labelledby="createStudentModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createStudentModalLabel">Создать нового ученика</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                    <div class="modal-body">
                        <form id="create-student-form">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label for="full_name" class="form-label">ФИО *</label>
                                <input type="text" class="form-control" id="full_name" name="full_name" required>
                            </div>
                            <div class="mb-3">
                                <label for="phone" class="form-label">Телефон</label>
                                <input type="tel" class="form-control" id="phone" name="phone">
                            </div>
                            <div class="mb-3">
                                <label for="parent_name" class="form-label">Родитель</label>
                                <input type="text" class="form-control" id="parent_name" name="parent_name">
                            </div>
                            <div class="mb-3">
                                <label for="default_price" class="form-label">Базовая цена</label>
                                <input type="number" class="form-control" id="default_price" name="default_price" value="11400">
                            </div>
                            <div class="mb-3">
                                <label for="attendance_type" class="form-label">Тип посещения *</label>
                                <select class="form-select" id="attendance_type" name="attendance_type" required>
                                    <option value="camp">Лагерь</option>
                                    <option value="lab">Лаборатория</option>
                                    <option value="full_day" selected>Полный день</option>
                                </select>
                            </div>
                        </form>
                    </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" id="save-student-btn">Сохранить</button>
                </div>
            </div>
        </div>
    </div>

<div class="modal fade" id="createEmployeeModal" tabindex="-1" aria-labelledby="createEmployeeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createEmployeeModalLabel">Создать нового сотрудника</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="create-employee-form">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="employee_full_name" class="form-label">ФИО *</label>
                        <input type="text" class="form-control" id="employee_full_name" name="full_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="position" class="form-label">Должность *</label>
                        <select class="form-select" id="position" name="position" required>
                            <option value="teacher">Преподаватель</option>
                            <option value="admin">Администратор</option>
                            <option value="camp_head">Начальник лагеря</option>
                            <option value="lab_head">Начальник лаборатории</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="branch" class="form-label">Филиал</label>
                        <select class="form-select" id="branch" name="branch_id">
                            <option value="">Выберите филиал</option>
                            {% for branch in available_branches %}
                            <option value="{{ branch.id }}">{{ branch.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="schedule" class="form-label">Смена</label>
                        <select class="form-select" id="schedule" name="schedule_id">
                            <option value="">Выберите смену</option>
                            {% for schedule in available_schedules %}
                            <option value="{{ schedule.id }}">{{ schedule.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="rate_per_day" class="form-label">Ставка за день</label>
                        <input type="number" class="form-control" id="rate_per_day" name="rate_per_day" value="1000">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="save-employee-btn">Сохранить</button>
            </div>
        </div>
    </div>
</div>

    <!-- Модальное окно для формы расхода -->
    <div class="modal fade" id="expenseModal" tabindex="-1" aria-labelledby="expenseModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content" id="expense-modal-content">
                <!-- Контент будет загружен через AJAX -->
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" id="payment-modal-content">
            <!-- Content will be loaded here by AJAX -->
        </div>
    </div>
</div>
<!-- Модальное окно для пополнения баланса -->
<div class="modal fade" id="balanceModal" tabindex="-1" aria-labelledby="balanceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="balanceModalLabel">Управление балансом</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs" id="balanceTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="add-balance-tab" data-bs-toggle="tab" data-bs-target="#add-balance" type="button" role="tab" aria-controls="add-balance" aria-selected="true">
                            Пополнение
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab" aria-controls="history" aria-selected="false">
                            История операций
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content p-3" id="balanceTabContent">
                    <!-- Вкладка пополнения баланса -->
                    <div class="tab-pane fade show active" id="add-balance" role="tabpanel" aria-labelledby="add-balance-tab">
                        <form id="balance-form">
                            {% csrf_token %}
                            <input type="hidden" name="student_id" id="balance-student-id">
                            <input type="hidden" name="operation_type" value="deposit">
                            <div class="mb-3">
                                <label for="balance-amount" class="form-label">Сумма пополнения *</label>
                                <input type="number" class="form-control" id="balance-amount" name="amount" 
                                       min="0" step="0.01" required>
                            </div>
                            <div class="mb-3">
                                <label for="balance-comment" class="form-label">Комментарий</label>
                                <input type="text" class="form-control" id="balance-comment" name="comment">
                            </div>
                        </form>
                    </div>
                    
                    <!-- Вкладка истории операций -->
                    <div class="tab-pane fade" id="history" role="tabpanel" aria-labelledby="history-tab">
                        <div class="table-responsive">
                            <table class="table table-sm" id="balance-history-table">
                                <thead>
                                    <tr>
                                        <th>Дата</th>
                                        <th>Тип операции</th>
                                        <th>Сумма</th>
                                        <th>Комментарий</th>
                                        <th>Кто внес</th>
                                    </tr>
                                </thead>
                                <tbody id="balance-history-body">
                                    <!-- История будет загружаться динамически -->
                                </tbody>
                            </table>
                        </div>
                        <div id="balance-history-empty" class="text-center py-4 d-none">
                            <p class="text-muted">Нет операций по балансу</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                <button type="button" class="btn btn-primary" id="save-balance-btn">Пополнить</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
  // Глобальные переменные для использования в JS
    const SCHEDULE_ID = "{{ schedule.id }}";
    const CSRF_TOKEN = "{{ csrf_token }}";
    const DATES_JSON = [
        {% for date in dates %}"{{ date|date:'Y-m-d' }}",{% endfor %}
    ];
</script>
<script src="{% static 'js/schedule_detail.js' %}"></script>
{% endblock %}