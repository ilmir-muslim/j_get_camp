{% extends 'base.html' %}
{% load schedule_extras %}

{% block extra_head %}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" />
{% endblock %}

{% block content %}
  <div class="container mt-4">
    <div class="calendar-header">
      <h1 class="calendar-title">Календарь смен</h1>
    </div>

    <div class="month-navigation">
      <a href="?month={{ prev_month }}" class="nav-btn"><i class="bi bi-arrow-left-circle"></i> Предыдущий месяц</a>
      <div class="month-title">{{ current_date|date:'F Y' }}</div>
      <a href="?month={{ next_month }}" class="nav-btn">Следующий месяц <i class="bi bi-arrow-right-circle"></i></a>
    </div>

    <div class="calendar-container">
      <table class="table calendar-table">
        <thead>
          <tr>
            <th class="branch-header">Филиал</th>
            {% for header in week_headers %}
              <th>{{ header }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for branch in branches %}
            <tr>
              <td class="branch-name">{{ branch.name }}</td>
              {% for week_start, week_end in weeks %}
                {% with cell=matrix|get_item:branch.id|get_item:week_start %}
                  <td class="calendar-cell" data-branch="{{ branch.id }}" data-week-start="{{ week_start|date:'Y-m-d' }}" data-week-end="{{ week_end|date:'Y-m-d' }}">
                    {% if cell %}
                      {% for sched in cell %}
                        <div class="schedule-card" style="border-left-color: {{ sched.color }};" data-id="{{ sched.id }}">
                          <h6>{{ sched.name }}</h6>
                          <div class="schedule-dates">
                            <div class="schedule-theme">{{ sched.theme }}</div>
                            <a href="{% url 'schedule_detail' sched.id %}" class="btn btn-sm btn-primary mt-2">
                              Детали
                            </a>
                          </div>
                        </div>
                      {% endfor %}
                    {% else %}
                      <div class="empty-cell">Добавить смену</div>
                    {% endif %}
                  </td>
                {% endwith %}
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Модальное окно для редактирования -->
  <div class="modal fade" id="scheduleModal" tabindex="-1" aria-labelledby="scheduleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content" id="modal-content">
        <!-- Контент будет загружен через AJAX -->
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_scripts %}
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <script>
    $(document).ready(function () {
      function handleCellClick(cell) {
        const branchId = $(cell).data('branch')
        const weekStart = $(cell).data('week-start')
        const weekEnd = $(cell).data('week-end')

        if ($(cell).find('.schedule-card').length > 0) {
          const scheduleId = $(cell).find('.schedule-card').first().data('id')
          editSchedule(scheduleId)
        } else {
          createNewSchedule(branchId, weekStart, weekEnd)
        }
      }

      function createNewSchedule(branchId, weekStart, weekEnd) {
        const url = "{% url 'schedule_quick_create' %}?branch=" + branchId + '&week_start=' + weekStart + '&week_end=' + weekEnd

        $('#modal-content').load(url, function () {
          $('#scheduleModal').modal('show')
        })
      }

      function editSchedule(scheduleId) {
        const url = "{% url 'schedule_quick_edit' 0 %}".replace('0', scheduleId)

        $('#modal-content').load(url, function () {
          $('#delete-schedule').click(function () {
            if (confirm('Вы уверены, что хотите удалить эту смену?')) {
              $.post(
                "{% url 'schedule_delete' 0 %}".replace('0', scheduleId),
                {
                  csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                function () {
                  $('#scheduleModal').modal('hide')
                  location.reload()
                }
              )
            }
          })

          $('#scheduleModal').modal('show')
        })
      }

      $('body').on('submit', '#schedule-quick-form', function (e) {
        e.preventDefault()
        const form = $(this)
        $.ajax({
          type: form.attr('method'),
          url: form.attr('action'),
          data: form.serialize(),
          success: function () {
            $('#scheduleModal').modal('hide')
            location.reload()
          },
          error: function (xhr) {
            $('#modal-content').html(xhr.responseText)
          }
        })
      })

      $('body').on('click', '.calendar-cell', function (e) {
        if ($(e.target).hasClass('calendar-cell')) {
          handleCellClick(this)
        }
      })

      $('body').on('click', '.empty-cell', function (e) {
        handleCellClick($(this).closest('.calendar-cell')[0])
      })

      $('body').on('click', '.schedule-card', function (e) {
        e.stopPropagation()
        const scheduleId = $(this).data('id')
        editSchedule(scheduleId)
      })
    })
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
