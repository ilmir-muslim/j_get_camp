{% extends 'base.html' %}
{% load schedule_extras %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/schedule_calendar.css' %}">
<link rel="stylesheet" href="{% static 'css/calendar.css' %}">
{% endblock %}

{% block content %}
  <div class="container mt-4">
    <div class="calendar-header">
      <h1 class="calendar-title">Календарь смен</h1>
    </div>

    <div class="month-navigation">
      <a href="?month={{ prev_month }}" class="nav-btn"><i class="bi bi-arrow-left-circle"></i> Предыдущий месяц</a>
      <div class="month-title">{{ current_date|date:'F Y' }}</div>
      <a href="?month={{ next_month }}" class="nav-btn">Следующий месяц <i class="bi bi-arrow-right-circle"></i></a>
    </div>

    <div class="calendar-container">
      <table class="table calendar-table">
    <thead>
      <tr>
        <th>Филиал</th>
        {% for header in week_headers %}
          <th class="date-header">{{ header }}</th> 
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for branch in branches %}
        <tr>
        <td class="branch-name" data-branch-id="{{ branch.id }}">{{ branch.name }}</td>
        {% for week_start, week_end in weeks %}
                {% with cell=matrix|get_item:branch.id|get_item:week_start %}
                  <td class="calendar-cell" data-branch="{{ branch.id }}" data-week-start="{{ week_start|date:'Y-m-d' }}" data-week-end="{{ week_end|date:'Y-m-d' }}">
                    {% if cell %}
                      {% for sched in cell %}
                        <div class="schedule-card" style="border-left-color: {{ sched.color }};" data-id="{{ sched.id }}">
                          <h6>{{ sched.name }}</h6>
                          <div class="schedule-dates">
                            <div class="schedule-theme">{{ sched.theme }}</div>
                            <button class="btn btn-sm btn-primary mt-2 edit-schedule-btn" 
                                    data-id="{{ sched.id }}">
                              Детали
                            </button>
                          </div>
                        </div>
                      {% endfor %}
                    {% else %}
                      <div class="empty-cell">Добавить смену</div>
                    {% endif %}
                  </td>
                {% endwith %}
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Модальное окно для редактирования -->
  <div class="modal fade" id="scheduleModal" tabindex="-1" aria-labelledby="scheduleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content" id="modal-content">
        <!-- Контент будет загружен через AJAX -->
      </div>
    </div>
  </div>

  <div class="modal fade" id="branchModal" tabindex="-1" aria-labelledby="branchModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content" id="branch-modal-content">
      <!-- Контент будет загружен через AJAX -->
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{% static 'js/schedule_calendar.js' %}"></script>
{% endblock %}