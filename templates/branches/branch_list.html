{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/tables.css' %}" />
<link rel="stylesheet" href="{% static 'css/forms.css' %}" />
{% endblock %}

{% block content %}
<div class="container mt-4">
  <a href="{% url 'dashboard' %}" class="btn btn-secondary mb-3">
    &larr; Назад на главную
  </a>

  <div class="card shadow-sm">
    <div class="card-header bg-primary text-white">
      <div class="d-flex justify-content-between align-items-center">
        <h3 class="mb-0">Филиалы</h3>
        <div>
          <button type="button" class="btn btn-light" id="add-branch-btn">
            <i class="bi bi-plus-lg"></i> Добавить филиал
          </button>
        </div>
      </div>
    </div>

    <div class="card-body">
      <!-- Строка поиска -->
      <div class="mb-3">
        <input type="text" id="branch-search" class="form-control" placeholder="Поиск филиала по названию...">
      </div>
      
      <div class="table-responsive">
        <table class="table table-striped table-hover" id="branches-table">
          <thead>
            <tr>
              <th>№</th>
              <th><i class="bi bi-gear-fill text-secondary fs-5"></i></th>
              <th>Название</th>
              <th>Адрес</th>
            </tr>
          </thead>
          <tbody>
            {% for branch in branches %}
            <tr id="branch-{{ branch.id }}">
              <td>{{ forloop.counter }}</td>
              <td>
                <button class="btn p-0 border-0 bg-transparent icon-btn edit-branch-btn"
                        data-branch-id="{{ branch.id }}">
                  <i class="bi bi-pencil text-primary"></i>
                </button>
                <button class="btn p-0 border-0 bg-transparent icon-btn delete-branch-btn"
                        data-branch-id="{{ branch.id }}">
                  <i class="bi bi-trash text-danger"></i>
                </button>
                <button class="btn p-0 border-0 bg-transparent icon-btn view-branch-btn"
                        data-branch-id="{{ branch.id }}"
                        data-bs-toggle="tooltip" title="Просмотр деталей">
                  <i class="bi bi-eye text-info"></i>
                </button>
              </td>
              <td>{{ branch.name }}</td>
              <td>{{ branch.address }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Модальное окно для деталей филиала -->
<div class="modal fade" id="viewBranchModal" tabindex="-1" aria-labelledby="viewBranchModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="viewBranchModalLabel">Детали филиала</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Основная информация -->
        <div class="mb-4">
          <h6 class="border-bottom pb-2">Основная информация</h6>
          <div class="row">
            <div class="col-md-12 mb-2">
              <strong>Название:</strong>
              <span id="branch-detail-name"></span>
            </div>
            <div class="col-md-12">
              <strong>Адрес:</strong>
              <span id="branch-detail-address"></span>
            </div>
          </div>
        </div>

        <!-- Сотрудники филиала -->
        <div>
          <h6 class="border-bottom pb-2">Сотрудники филиала</h6>
          <div class="table-responsive">
            <table class="table table-sm" id="branch-employees-table">
              <thead>
                <tr>
                  <th>ФИО</th>
                  <th>Должность</th>
                  <th>Смена</th>
                  <th>Ставка за день</th>
                </tr>
              </thead>
              <tbody>
                <!-- Данные будут заполняться через JavaScript -->
              </tbody>
            </table>
          </div>
          <div id="no-employees-message" class="text-muted text-center d-none">
            В этом филиале нет сотрудников
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
      </div>
    </div>
  </div>
</div>

<!-- Модальное окно для создания филиала -->
<div class="modal fade" id="createBranchModal" tabindex="-1" aria-labelledby="createBranchModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="createBranchModalLabel">Создать новый филиал</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="create-branch-form">
          {% csrf_token %}
          <div class="mb-3">
            <label for="branch-name" class="form-label">Название *</label>
            <input type="text" class="form-control" id="branch-name" name="name" required>
          </div>
          <div class="mb-3">
            <label for="branch-address" class="form-label">Адрес</label>
            <textarea class="form-control" id="branch-address" name="address" rows="3"></textarea>
          </div>
          <!-- Добавлено поле города -->
          <div class="mb-3">
            <label for="branch-city" class="form-label">Город</label>
            <select class="form-control" id="branch-city" name="city_id">
              <option value="">--- Выберите город ---</option>
              {% for city in cities %}
              <option value="{{ city.id }}">{{ city.name }}</option>
              {% endfor %}
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
        <button type="button" class="btn btn-primary" id="save-branch-btn">Сохранить</button>
      </div>
    </div>
  </div>
</div>


<!-- Модальное окно для редактирования филиала -->
<div class="modal fade" id="editBranchModal" tabindex="-1" aria-labelledby="editBranchModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editBranchModalLabel">Редактировать филиал</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="edit-branch-form">
          {% csrf_token %}
          <input type="hidden" id="edit-branch-id" name="id">
          <div class="mb-3">
            <label for="edit-branch-name" class="form-label">Название *</label>
            <input type="text" class="form-control" id="edit-branch-name" name="name" required>
          </div>
          <div class="mb-3">
            <label for="edit-branch-address" class="form-label">Адрес</label>
            <textarea class="form-control" id="edit-branch-address" name="address" rows="3"></textarea>
          </div>
          <!-- Добавлено поле города -->
          <div class="mb-3">
            <label for="edit-branch-city" class="form-label">Город</label>
            <select class="form-control" id="edit-branch-city" name="city_id">
              <option value="">--- Выберите город ---</option>
              {% for city in cities %}
              <option value="{{ city.id }}">{{ city.name }}</option>
              {% endfor %}
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
        <button type="button" class="btn btn-primary" id="update-branch-btn">Обновить</button>
      </div>
    </div>
  </div>
</div>

<!-- Модальное окно для подтверждения удаления -->
<div class="modal fade" id="deleteBranchModal" tabindex="-1" aria-labelledby="deleteBranchModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteBranchModalLabel">Подтверждение удаления</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Вы уверены, что хотите удалить филиал "<span id="delete-branch-name"></span>"?</p>
        <p class="text-danger">Это действие нельзя отменить.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
        <button type="button" class="btn btn-danger" id="confirm-delete-branch-btn">Удалить</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
  const CSRF_TOKEN = "{{ csrf_token }}";
  const API_BRANCHES_URL = "/api/branches/";
  const API_EMPLOYEES_URL = "/api/employees/";
  
  // Добавляем информацию о пользователе
  const USER_ROLE = "{{ user.role }}";
  const USER_CITY_ID = "{{ user.city.id|default:'' }}";
  const USER_CITY_NAME = "{{ user.city.name|default:'' }}";
</script>
<script src="{% static 'js/branch_list.js' %}"></script>
<script src="{% static 'js/utils.js' %}"></script>
{% endblock %}