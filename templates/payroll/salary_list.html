{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/tables.css' %}">
<link rel="stylesheet" href="{% static 'css/forms.css' %}">
<style>
.salary-table {
  width: 100%;
  margin-bottom: 1rem;
  background-color: transparent;
  border-collapse: collapse;
}

.salary-table th,
.salary-table td {
  padding: 0.75rem;
  vertical-align: top;
  border-top: 1px solid #dee2e6;
}

.salary-table thead th {
  vertical-align: bottom;
  border-bottom: 2px solid #dee2e6;
  background-color: #f8f9fa;
  font-weight: 600;
}

.salary-table tbody tr:hover {
  background-color: rgba(0, 0, 0, 0.075);
}

.clickable-salary-row {
  transition: all 0.3s ease;
  cursor: pointer;
}

.clickable-salary-row:hover {
  background-color: #f1f3f5;
  transform: translateX(3px);
}

.status-badge {
  padding: 0.35em 0.65em;
  border-radius: 0.25rem;
}

.status-paid {
  background-color: #d4edda;
  color: #155724;
}

.status-unpaid {
  background-color: #f8d7da;
  color: #721c24;
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
  <a href="{% url 'dashboard' %}" class="btn btn-secondary mb-3">
    &larr; Назад на главную
  </a>

  <div class="card shadow-sm">
    <div class="card-header bg-primary text-white">
      <div class="d-flex justify-content-between align-items-center">
        <h3 class="mb-0">Управление зарплатами</h3>
        <div>
          {% if show_unpaid %}
            <a href="{% url 'salary_list' %}" class="btn btn-light me-2">Показать все</a>
          {% else %}
            <a href="{% url 'salary_list' %}?unpaid=1" class="btn btn-warning me-2">Только невыплаченные</a>
          {% endif %}
          <button type="button" class="btn btn-light" id="add-salary-btn">
            <i class="bi bi-plus-lg"></i> Добавить зарплату
          </button>
        </div>
      </div>
    </div>

    <div class="card-body">
      <div class="table-responsive">
        <table class="table salary-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Сотрудник</th>
              <th>Смена</th>
              <th>Тип выплаты</th>
              <th>Дней отработано</th>
              <th>Ставка за день</th>
              <th>% от оплаты</th>
              <th>Итоговая сумма</th>
              <th>Статус</th>
              <th>Действия</th>
            </tr>
          </thead>
          <tbody id="salaries-table-body">
          {% for data in salary_data %}
          {% with salary=data.salary days_worked=data.days_worked_calculated %}
          <tr data-salary-id="{{ salary.id }}" class="clickable-salary-row">
            <td>{{ salary.id }}</td>
            <td>{{ salary.employee.full_name }}</td>
            <td>{{ salary.schedule.name }} ({{ salary.schedule.start_date }} - {{ salary.schedule.end_date }})</td>
            <td>{{ salary.get_payment_type_display }}</td>
            <td>{{ days_worked }}</td>  <!-- Используем вычисленное значение -->
            <td>{{ salary.daily_rate }}</td>
            <td>{{ salary.percent_rate }}</td>
            <td>{{ salary.total_payment }}</td>
            <td>
              {% if salary.is_paid %}
                <span class="status-badge status-paid">✅ Выплачено</span>
              {% else %}
                <span class="status-badge status-unpaid">❌ Не выплачено</span>
              {% endif %}
            </td>
            <td>
              <button class="btn p-0 border-0 bg-transparent icon-btn delete-salary-btn"
                      data-salary-id="{{ salary.id }}">
                <i class="bi bi-trash text-danger fs-5"></i>
              </button>
            </td>
          </tr>
          {% endwith %}
          {% endfor %}

          </tbody>
          <tfoot>
            <tr class="total-summary-row">
              <td colspan="7" class="text-end"><strong>Итого:</strong></td>
              <td class="text-center"><strong>{{ total_salary }}</strong></td>
              <td colspan="2"></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Модальное окно для формы зарплаты -->
<div class="modal fade" id="salaryModal" tabindex="-1" aria-labelledby="salaryModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content" id="salary-modal-content">
      <!-- Сюда будет загружаться форма -->
    </div>
  </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
  // Глобальные переменные
  const CSRF_TOKEN = "{{ csrf_token }}";
  
  document.addEventListener('DOMContentLoaded', function () {
    // Функция для загрузки формы зарплаты
    function loadSalaryForm(url) {
      fetch(url)
        .then(response => response.text())
        .then(html => {
          document.getElementById('salary-modal-content').innerHTML = html;
          const modal = new bootstrap.Modal(document.getElementById('salaryModal'));
          modal.show();
        });
    }

    // Обработчик для кнопки добавления зарплаты
    document.getElementById('add-salary-btn').addEventListener('click', function () {
      loadSalaryForm('{% url "salary_create" %}');
    });

    // Обработчик кликов по строкам зарплат (для редактирования)
    document.querySelectorAll('.clickable-salary-row').forEach(row => {
      row.addEventListener('click', function (e) {
        // Игнорируем клики на кнопке удаления
        if (!e.target.closest('.delete-salary-btn')) {
          const salaryId = this.dataset.salaryId;
          loadSalaryForm(`/payroll/salaries/edit/${salaryId}/`);
        }
      });
    });

    // Обработчик кликов по кнопкам удаления
    document.addEventListener('click', function (e) {
      const deleteBtn = e.target.closest('.delete-salary-btn');
      if (deleteBtn) {
        const salaryId = deleteBtn.dataset.salaryId;

        if (confirm('Вы уверены, что хотите удалить эту запись о зарплате?')) {
          fetch(`/payroll/salaries/delete/${salaryId}/`, {
            method: 'POST',
            headers: {
              'X-CSRFToken': CSRF_TOKEN,
              'X-Requested-With': 'XMLHttpRequest'
            }
          })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                // Удаляем строку из таблицы
                const row = document.querySelector(`tr[data-salary-id="${salaryId}"]`);
                if (row) row.remove();
                
                // Показываем уведомление
                showToast('Запись о зарплате успешно удалена', 'success');
                
                // Пересчитываем общую сумму
                updateSalaryTotal();
              }
            })
            .catch(error => {
              console.error('Error:', error);
              showToast('Произошла ошибка при удалении записи', 'error');
            });
        }
      }
    });

    // Функция для обновления общей суммы зарплат
    function updateSalaryTotal() {
      let total = 0;
      document.querySelectorAll('#salaries-table-body tr').forEach(row => {
        const amountCell = row.cells[7];
        const amount = parseFloat(amountCell.textContent);
        total += amount;
      });

      document.querySelector('.total-summary-row td:nth-child(2)').textContent = total.toFixed(2);
    }

    // Обработчик отправки формы зарплаты
document.addEventListener('submit', function (e) {
    if (e.target.id === 'salary-form') {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': CSRF_TOKEN,
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Закрываем модальное окно
                const modal = bootstrap.Modal.getInstance(document.getElementById('salaryModal'));
                modal.hide();
                
                // Показываем уведомление об успехе
                showToast('Данные успешно сохранены', 'success');
                
                // Обновляем страницу
                location.reload();
            } else {
                // Обновляем форму с ошибками валидации
                document.getElementById('salary-modal-content').innerHTML = data.form_html;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Произошла ошибка при сохранении', 'error');
        });
    }
});


</script>
{% endblock %}